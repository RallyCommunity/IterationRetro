<!DOCTYPE html>
<html>
<head>
    <title>Iteration Retrospective</title>

    <script type="text/javascript" src="https://rally1.rallydev.com/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var REQUIRED_FIELDS=["Retro Pluses","Retro Deltas","Retro Actions"];Ext.define("IterationRetroApp",{extend:"Rally.app.TimeboxScopedApp",componentCls:"app",scopeType:"iteration",supportsUnscheduled:!1,layout:{type:"vbox",align:"stretch"},items:[{xtype:"container",cls:"header"},{xtype:"container",itemId:"content",flex:1}],onScopeChange:function(){this.callParent(arguments),this.models?this._checkForFields():Rally.data.wsapi.ModelFactory.getModels({context:this.getContext(),types:["Iteration","AttributeDefinition"],success:function(models){this.models=models,this._checkForFields()},scope:this})},_checkForFields:function(){if(this.down("#content").removeAll(),_.every(REQUIRED_FIELDS,this._fieldExists,this))this.add({xtype:"rallyrichtexteditor"});else{var isWorkspaceAdmin=this.getContext().getPermissions().isWorkspaceOrSubscriptionAdmin(this.getContext().getWorkspace());this.down("#content").add({itemId:"missingFieldsBlankSlate",xtype:"container",cls:"no-data-container",items:[{xtype:"component",cls:"primary-message",html:"One or more required Iteration custom fields are missing."},{xtype:"component",cls:"secondary-message",html:"This app uses custom fields on Iteration to store retro pluses, deltas and action items."},{xtype:"component",cls:"secondary-message",html:isWorkspaceAdmin?'Click <a href="#" class="create-fields-link">here</a> to create these fields.':"Please contact a workspace administrator to set up these fields using this app.",listeners:{afterrender:function(cmp){var linkEl=cmp.getEl().down(".create-fields-link");this.mon(linkEl,"click",this._createRequiredFields,this)},scope:this}}]})}},_fieldExists:function(name){return!!_.find(this.models.Iteration.getFields(),function(field){return field.isCustom()&&"text"===field.getType()&&field.displayName===name})},_createRequiredFields:function(e){e.preventDefault(),this.setLoading({msg:"Creating fields..."}),Deft.Promise.all(_.compact(_.map(REQUIRED_FIELDS,function(field){return this._fieldExists(field)?void 0:this._createRequiredField(field)},this))).then({success:this._requiredFieldsCreated,scope:this})},_createRequiredField:function(name){_.each(["RealAttributeType","Constrained","TypeDefinition"],function(fieldName){this.models.AttributeDefinition.getField(fieldName).persist=!0},this);var newField=Ext.create(this.models.AttributeDefinition,{RealAttributeType:"TEXT",Constrained:!1,Custom:!0,Filterable:!0,Sortable:!1,Name:name,TypeDefinition:Rally.util.Ref.getRelativeUri(this.models.Iteration.typeDefinition)});return newField.save()},_requiredFieldsCreated:function(){Rally.data.wsapi.ModelFactory.clearModels(),Rally.data.wsapi.ModelFactory.getModel({context:this.getContext(),type:"Iteration"}).then({success:function(model){this.models.Iteration=model,this.setLoading(!1),this.onScopeChange()},scope:this})}});

            Rally.launchApp('IterationRetroApp', {
                name:"Iteration Retrospective",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        
    </style>
</head>
<body>
</body>
</html>
