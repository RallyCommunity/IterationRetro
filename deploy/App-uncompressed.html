<!DOCTYPE html>
<html>
<head>
    <title>Iteration Retrospective</title>

    <script type="text/javascript" src="/apps/2.1/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                var REQUIRED_FIELDS = [
  'Retro Pluses',
  'Retro Deltas',
  'Retro Actions'
];

Ext.define('IterationRetroApp', {
    extend: 'Rally.app.TimeboxScopedApp',
    componentCls: 'app',
    scopeType: 'iteration',
    supportsUnscheduled: false,

    layout: {
        type: 'vbox',
        align: 'stretch'
    },

    initComponent: function() {
        this.callParent(arguments);

        this.add({
            xtype: 'container',
            itemId: 'content',
            flex: 1,
            layout: {
                type: 'vbox',
                align: 'stretch'
            }
        });
    },

    onScopeChange: function() {
        this.callParent(arguments);

        if (!this.models) {
            Rally.data.wsapi.ModelFactory.getModels({
                context: this.getContext(),
                types: ['Iteration', 'AttributeDefinition'],
                success: function(models) {
                    this.models = models;
                    this._loadIteration();
                },
                scope: this
            });
        } else {
            this._loadIteration();
        }
    },

    _loadIteration: function() {
        var id = this.getContext().getTimeboxScope().getRecord().getId();
        this.models.Iteration.load(id, {
            fetch: REQUIRED_FIELDS
        }).then({
            success: function(iteration) {
                this.iteration = iteration;
                this._checkForFields();
            },
            scope: this
        });
    },

    _checkForFields: function() {
        var contentContainer = this.down('#content');
        contentContainer.removeAll();
        if (!_.every(REQUIRED_FIELDS, this._fieldExists, this)) {
            var isWorkspaceAdmin = this.getContext().getPermissions().isWorkspaceOrSubscriptionAdmin(this.getContext().getWorkspace());
            contentContainer.add({
                itemId: 'missingFieldsBlankSlate',
                xtype: 'container',
                cls: 'no-data-container',
                items: [
                    {
                        xtype: 'component',
                        cls: 'primary-message',
                        html: 'One or more required Iteration custom fields are missing.'
                    },
                    {
                        xtype: 'component',
                        cls: 'secondary-message',
                        html: 'This app uses custom fields on Iteration to store retro pluses, deltas and action items.'
                    },
                    {
                        xtype: 'component',
                        cls: 'secondary-message',
                        html: isWorkspaceAdmin ?
                          'Click <a href="#" class="create-fields-link">here</a> to create these fields.' :
                          'Please contact a workspace administrator to set up these fields using this app.',
                        listeners: {
                            afterrender: function(cmp) {
                                var linkEl = cmp.getEl().down('.create-fields-link');
                                this.mon(linkEl, 'click', this._createRequiredFields, this);
                            },
                            scope: this
                        }
                    }
                ]
            });
        } else {
            contentContainer.add([
                {
                    xtype: 'container',
                    layout: {
                        type: 'hbox'
                    },
                    items: [
                        {
                            xtype: 'panel',
                            cls: 'plus-panel',
                            title: '+',
                            titleAlign: 'center',
                            flex: 1,
                            minWidth: 550,
                            items: [ this._buildEditorFor('c_RetroPluses') ]
                        },
                        {
                            xtype: 'panel',
                            cls: 'delta-panel',
                            title: 'Î”',
                            titleAlign: 'center',
                            flex: 1,
                            minWidth: 550,
                            items: [ this._buildEditorFor('c_RetroDeltas') ]
                        }
                   ]
                },
                {
                    xtype: 'panel',
                    cls: 'actions-panel',
                    title: 'Action Items',
                    titleAlign: 'center',
                    flex: 1,
                    items: [ this._buildEditorFor('c_RetroActions') ]
                }
            ]);
        }
    },

    _buildEditorFor: function(fieldName) {
        return {
            xtype: 'rallyrichtexteditor',
            itemId: fieldName.replace('c_R', 'r'),
            fieldName: fieldName,
            margin: '0 10px',
            height: 300,
            value: this.iteration.get(fieldName),
            listeners: {
                blur: this._onEditorChange,
                scope: this
            }
        };
    },

    _fieldExists: function(name) {
        return !!_.find(this.models.Iteration.getFields(), function(field) {
            return field.isCustom() && field.getType() === 'text' && field.displayName === name;
        });
    },

    _createRequiredFields: function(e) {
        e.preventDefault();
        this.setLoading({ msg: 'Creating fields...' });

        Deft.Promise.all(_.compact(_.map(REQUIRED_FIELDS, function(field) {
            if (!this._fieldExists(field)) {
                return this._createRequiredField(field);
            }
        }, this))).then({
            success: this._requiredFieldsCreated,
            scope: this
        });
    },

    _createRequiredField: function(name) {
        //hack to make required fields persistable
        _.each(['RealAttributeType', 'Constrained', 'TypeDefinition'], function(fieldName) {
            this.models.AttributeDefinition.getField(fieldName).persist = true;
        }, this);
        //end hack

        var newField = Ext.create(this.models.AttributeDefinition, {
            RealAttributeType: 'TEXT',
            Constrained: false,
            Custom: true,
            Filterable: true,
            Sortable: false,
            Name: name,
            TypeDefinition: Rally.util.Ref.getRelativeUri(this.models.Iteration.typeDefinition)
        });
        return newField.save();
    },

    _requiredFieldsCreated: function() {
        Rally.data.wsapi.ModelFactory.clearModels();
        Rally.data.wsapi.ModelFactory.getModel({
            context: this.getContext(),
            type: 'Iteration'
        }).then({
            success: function(model) {
                this.models.Iteration = model;
                this.setLoading(false);
                this.onScopeChange();
            },
            scope: this
        });
    },

    _onEditorChange: function(editor) {
        this.iteration.set(editor.fieldName, editor.getValue());
        this.iteration.save({
            fetch: REQUIRED_FIELDS
        }).then({
            success: function(iteration) {
                this.iteration = iteration;
                Ext.create('Rally.ui.detail.view.SavedIndicator', {
                    target: editor
                });
            },
            scope: this
        });
    }
});


            Rally.launchApp('IterationRetroApp', {
                name:"Iteration Retrospective",
	            parentRepos:""
            });

        });
    </script>



    <style type="text/css">
        .app {
  /* Add app styles here */
}
.x-panel-body {
  border: none;
}
.x-panel-header-default {
  box-shadow: none;
}
.x-panel-header-text-container-default {
  line-height: 48px;
  color: #ccc;
}
.plus-panel {
  /*border-right: 1px solid #ccc;*/
  padding-bottom: 20px;
}
.delta-panel {
  /*border-left: 1px solid #ccc;*/
  padding-bottom: 20px;
}
.actions-panel {
  /*border-top: 2px solid #ccc;*/
}
.plus-panel .x-panel-header-text-container-default {
  font-size: 72px;
}
.delta-panel .x-panel-header-text-container-default {
  font-size: 48px;
}
.actions-panel .x-panel-header-text-container-default {
  font-size: 36px;
  text-transform: none;
}
#rich-text-editor-templates-button {
  display: none;
}

    </style>
</head>
<body>
</body>
</html>
